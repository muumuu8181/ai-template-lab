name: Notify App Added

# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯published-appsãƒªãƒã‚¸ãƒˆãƒªã§æ–°ã—ã„ã‚¢ãƒ—ãƒªãŒè¿½åŠ ã•ã‚ŒãŸæ™‚ã«
# firebase-app-reviewerãƒªãƒã‚¸ãƒˆãƒªã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡ã—ã¾ã™

on:
  push:
    branches: [ main ]
    paths:
      - 'app-*/**'  # app-ã§å§‹ã¾ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã®å¤‰æ›´ã‚’ç›£è¦–

jobs:
  notify-reviewer:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Check for new apps
      id: check_apps
      run: |
        # æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸã‚¢ãƒ—ãƒªãƒ•ã‚©ãƒ«ãƒ€ã‚’æ¤œå‡º
        echo "ğŸ” æ–°ã—ã„ã‚¢ãƒ—ãƒªã‚’æ¤œç´¢ä¸­..."
        
        # æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆã§è¿½åŠ ã•ã‚ŒãŸapp-*ãƒ•ã‚©ãƒ«ãƒ€ã‚’å–å¾—
        NEW_APPS=$(git diff --name-only HEAD~1 HEAD | grep '^app-.*/' | cut -d'/' -f1 | sort -u)
        
        if [ -n "$NEW_APPS" ]; then
          echo "ğŸ†• æ–°ã—ã„ã‚¢ãƒ—ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:"
          echo "$NEW_APPS"
          echo "has_new_apps=true" >> $GITHUB_OUTPUT
          
          # ã‚¢ãƒ—ãƒªãƒªã‚¹ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo "$NEW_APPS" > new_apps.txt
        else
          echo "ğŸ“ æ–°ã—ã„ã‚¢ãƒ—ãƒªã¯ã‚ã‚Šã¾ã›ã‚“"
          echo "has_new_apps=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Trigger Firebase App Reviewer Update
      if: steps.check_apps.outputs.has_new_apps == 'true'
      run: |
        echo "ğŸš€ Firebase App Reviewerã«æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡ä¸­..."
        
        # GitHub APIã‚’ä½¿ç”¨ã—ã¦repository_dispatchã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡
        curl -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/${{ github.repository_owner }}/firebase-app-reviewer/dispatches \
          -d '{
            "event_type": "app-added",
            "client_payload": {
              "repository": "${{ github.repository }}",
              "new_apps": '"$(cat new_apps.txt | jq -R -s -c 'split("\n")[:-1]')"',
              "timestamp": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"
            }
          }'
        
        echo "âœ… æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡å®Œäº†"
    
    - name: Summary
      run: |
        echo "=== å®Ÿè¡Œã‚µãƒãƒªãƒ¼ ==="
        echo "ğŸ“‚ ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}"
        echo "ğŸ”„ ãƒˆãƒªã‚¬ãƒ¼: ãƒ—ãƒƒã‚·ãƒ¥ã‚¤ãƒ™ãƒ³ãƒˆ"
        echo "ğŸ• å®Ÿè¡Œæ™‚åˆ»: $(date)"
        
        if [ "${{ steps.check_apps.outputs.has_new_apps }}" == "true" ]; then
          echo "âœ… çµæœ: æ–°ã—ã„ã‚¢ãƒ—ãƒªæ¤œå‡ºãƒ»é€šçŸ¥é€ä¿¡å®Œäº†"
          echo "ğŸ“± æ¤œå‡ºã‚¢ãƒ—ãƒª:"
          if [ -f new_apps.txt ]; then
            cat new_apps.txt | sed 's/^/  - /'
          fi
        else
          echo "ğŸ“ çµæœ: æ–°ã—ã„ã‚¢ãƒ—ãƒªãªã—"
        fi