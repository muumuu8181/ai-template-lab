name: Update App Data

on:
  # published-appsãƒªãƒã‚¸ãƒˆãƒªã®å¤‰æ›´ã‚’ç›£è¦–ï¼ˆrepository_dispatchã‚¤ãƒ™ãƒ³ãƒˆï¼‰
  repository_dispatch:
    types: [app-added]
  
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
  
  # æ¯æ—¥è‡ªå‹•å®Ÿè¡Œï¼ˆåˆå‰9æ™‚ JSTï¼‰
  schedule:
    - cron: '0 0 * * *'

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: |
        # Node.jsã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã«å¿…è¦ãªä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        echo "Node.jsç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ"
    
    - name: Get previous stats
      id: prev_stats
      run: |
        echo "ğŸ“Š å‰å›ã®çµ±è¨ˆã‚’å–å¾—ä¸­..."
        if [ -f data.json ] && command -v jq &> /dev/null; then
          PREV_TOTAL=$(jq '.summary.total // 0' data.json)
          PREV_ACCESSIBLE=$(jq '.summary.accessible // 0' data.json)
          echo "prev_total=$PREV_TOTAL" >> $GITHUB_OUTPUT
          echo "prev_accessible=$PREV_ACCESSIBLE" >> $GITHUB_OUTPUT
          echo "ğŸ“± å‰å›çµ±è¨ˆ: ç·è¨ˆ${PREV_TOTAL}ä»¶ã€ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½${PREV_ACCESSIBLE}ä»¶"
        else
          echo "prev_total=0" >> $GITHUB_OUTPUT
          echo "prev_accessible=0" >> $GITHUB_OUTPUT
          echo "ğŸ“ å‰å›ãƒ‡ãƒ¼ã‚¿ãªã—ï¼ˆåˆå›å®Ÿè¡Œï¼‰"
        fi

    - name: Update app data
      id: update_data
      run: |
        echo "ğŸ” ã‚¢ãƒ—ãƒªãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ä¸­..."
        
        # é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²
        START_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')
        echo "â° é–‹å§‹æ™‚åˆ»: $START_TIME"
        
        # github-pages-status-checker.cjsã‚’å®Ÿè¡Œã—ã¦data.jsonã‚’ç”Ÿæˆ
        node github-pages-status-checker.cjs > github-pages-status.json
        
        # data.jsonã¨ã—ã¦ä¿å­˜
        cp github-pages-status.json data.json
        
        echo "ğŸ“Š ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº†"
        
        # æ–°ã—ã„çµ±è¨ˆã‚’å–å¾—
        if [ -f data.json ] && command -v jq &> /dev/null; then
          NEW_TOTAL=$(jq '.summary.total // 0' data.json)
          NEW_ACCESSIBLE=$(jq '.summary.accessible // 0' data.json)
          TIMESTAMP=$(jq -r '.timestamp // "ä¸æ˜"' data.json)
          
          echo "new_total=$NEW_TOTAL" >> $GITHUB_OUTPUT
          echo "new_accessible=$NEW_ACCESSIBLE" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "start_time=$START_TIME" >> $GITHUB_OUTPUT
          
          # çµ±è¨ˆã‚’è¡¨ç¤º
          echo "=== æ›´æ–°çµ±è¨ˆ ==="
          echo "âœ… data.jsonæ›´æ–°æˆåŠŸ"
          echo "ğŸ“± ç·ã‚¢ãƒ—ãƒªæ•°: $NEW_TOTAL"
          echo "âœ… ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½: $NEW_ACCESSIBLE"
          echo "âŒ ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯: $((NEW_TOTAL - NEW_ACCESSIBLE))"
          
          # å¤‰åŒ–ã‚’è¨ˆç®—
          TOTAL_DIFF=$((NEW_TOTAL - ${{ steps.prev_stats.outputs.prev_total }}))
          ACCESSIBLE_DIFF=$((NEW_ACCESSIBLE - ${{ steps.prev_stats.outputs.prev_accessible }}))
          
          echo "ğŸ“ˆ å¤‰åŒ–: ç·è¨ˆ${TOTAL_DIFF:+"+"}$TOTAL_DIFFä»¶ã€ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½${ACCESSIBLE_DIFF:+"+"}$ACCESSIBLE_DIFFä»¶"
        else
          echo "âŒ data.jsonç”Ÿæˆå¤±æ•—"
          exit 1
        fi
    
    - name: Check for changes
      id: changes
      run: |
        # Gitã®å¤‰æ›´ã‚’ç¢ºèª
        if git diff --quiet data.json; then
          echo "å¤‰æ›´ãªã—"
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "å¤‰æ›´ã‚ã‚Š"
          echo "changed=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Create execution log
      id: create_log
      run: |
        # å®Ÿè¡Œãƒ­ã‚°ã‚’ä½œæˆ
        LOG_FILE="execution-logs/data-update-$(date '+%Y%m%d-%H%M%S').md"
        mkdir -p execution-logs
        
        cat > "$LOG_FILE" << EOF
# ğŸ“Š Data.json è‡ªå‹•æ›´æ–°ãƒ­ã‚°

## å®Ÿè¡Œæƒ…å ±
- **å®Ÿè¡Œæ—¥æ™‚**: ${{ steps.update_data.outputs.start_time }}
- **ãƒˆãƒªã‚¬ãƒ¼**: ${{ github.event_name }}
- **å®Ÿè¡Œè€…**: GitHub Actions
- **ãƒªãƒã‚¸ãƒˆãƒª**: ${{ github.repository }}

## æ›´æ–°çµæœ
### ğŸ“± ã‚¢ãƒ—ãƒªçµ±è¨ˆ
- **æ›´æ–°å‰**: ç·è¨ˆ${{ steps.prev_stats.outputs.prev_total }}ä»¶ã€ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½${{ steps.prev_stats.outputs.prev_accessible }}ä»¶
- **æ›´æ–°å¾Œ**: ç·è¨ˆ${{ steps.update_data.outputs.new_total }}ä»¶ã€ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½${{ steps.update_data.outputs.new_accessible }}ä»¶
- **å¤‰åŒ–**: ç·è¨ˆ$((${{ steps.update_data.outputs.new_total }} - ${{ steps.prev_stats.outputs.prev_total }}))ä»¶ã€ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½$((${{ steps.update_data.outputs.new_accessible }} - ${{ steps.prev_stats.outputs.prev_accessible }}))ä»¶

### ğŸ“‹ å‡¦ç†çŠ¶æ³
- **data.jsonæ›´æ–°**: âœ… æˆåŠŸ
- **å¤‰æ›´æ¤œå‡º**: ${{ steps.changes.outputs.changed == 'true' && 'ğŸ”„ å¤‰æ›´ã‚ã‚Š' || 'ğŸ“ å¤‰æ›´ãªã—' }}
- **Gitåæ˜ **: ${{ steps.changes.outputs.changed == 'true' && 'ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥å®Ÿè¡Œ' || 'ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå¤‰æ›´ãªã—ï¼‰' }}

## ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æƒ…å ±
- **ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—**: ${{ steps.update_data.outputs.timestamp }}
- **ã‚½ãƒ¼ã‚¹ãƒªãƒã‚¸ãƒˆãƒª**: muumuu8181/published-apps
- **ãƒã‚§ãƒƒã‚«ãƒ¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**: github-pages-status-checker.cjs

---
*è‡ªå‹•ç”Ÿæˆãƒ­ã‚° - GitHub Actions*
EOF
        
        echo "log_file=$LOG_FILE" >> $GITHUB_OUTPUT
        echo "ğŸ“‹ å®Ÿè¡Œãƒ­ã‚°ä½œæˆ: $LOG_FILE"

    - name: Commit and push changes
      if: steps.changes.outputs.changed == 'true'
      run: |
        # Gitè¨­å®š
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆï¼ˆãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å«ã‚€ï¼‰
        git add data.json execution-logs/
        git commit -m "ğŸ¤– Auto-update app data (${{ steps.update_data.outputs.start_time }})

ğŸ“Š ã‚¢ãƒ—ãƒªãƒ‡ãƒ¼ã‚¿è‡ªå‹•æ›´æ–°:
- æ›´æ–°å‰: ${{ steps.prev_stats.outputs.prev_total }}ä»¶ â†’ æ›´æ–°å¾Œ: ${{ steps.update_data.outputs.new_total }}ä»¶
- ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½: ${{ steps.prev_stats.outputs.prev_accessible }}ä»¶ â†’ ${{ steps.update_data.outputs.new_accessible }}ä»¶
- å¤‰åŒ–: +$((${{ steps.update_data.outputs.new_total }} - ${{ steps.prev_stats.outputs.prev_total }}))ä»¶ï¼ˆç·è¨ˆï¼‰ã€+$((${{ steps.update_data.outputs.new_accessible }} - ${{ steps.prev_stats.outputs.prev_accessible }}))ä»¶ï¼ˆã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼‰

ğŸ“‹ å®Ÿè¡Œãƒ­ã‚°: ${{ steps.create_log.outputs.log_file }}

ğŸ¤– Generated by GitHub Actions"
        
        # ãƒ—ãƒƒã‚·ãƒ¥
        git push
        
        echo "âœ… å¤‰æ›´ã¨ãƒ­ã‚°ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
    
    - name: No changes detected
      if: steps.changes.outputs.changed == 'false'
      run: |
        echo "ğŸ“ å¤‰æ›´ãªã—: data.jsonã¯æœ€æ–°ã®çŠ¶æ…‹ã§ã™"

    - name: Summary
      run: |
        echo "=== å®Ÿè¡Œã‚µãƒãƒªãƒ¼ ==="
        echo "ğŸ• å®Ÿè¡Œæ™‚åˆ»: $(date)"
        echo "ğŸ“‚ ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}"
        echo "ğŸ”„ ã‚¤ãƒ™ãƒ³ãƒˆ: ${{ github.event_name }}"
        
        if [ "${{ steps.changes.outputs.changed }}" == "true" ]; then
          echo "âœ… çµæœ: ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒ»ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†"
        else
          echo "ğŸ“ çµæœ: å¤‰æ›´ãªã—ï¼ˆæœ€æ–°çŠ¶æ…‹ï¼‰"
        fi