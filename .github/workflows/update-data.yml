name: Update App Data

on:
  # published-appsãƒªãƒã‚¸ãƒˆãƒªã®å¤‰æ›´ã‚’ç›£è¦–ï¼ˆrepository_dispatchã‚¤ãƒ™ãƒ³ãƒˆï¼‰
  repository_dispatch:
    types: [app-added]
  
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
  
  # æ¯æ—¥è‡ªå‹•å®Ÿè¡Œï¼ˆåˆå‰9æ™‚ JSTï¼‰
  schedule:
    - cron: '0 0 * * *'

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: |
        # Node.jsã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã«å¿…è¦ãªä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        echo "Node.jsç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ"
    
    - name: Update app data
      run: |
        echo "ğŸ” ã‚¢ãƒ—ãƒªãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ä¸­..."
        
        # github-pages-status-checker.cjsã‚’å®Ÿè¡Œã—ã¦data.jsonã‚’ç”Ÿæˆ
        node github-pages-status-checker.cjs > github-pages-status.json
        
        # data.jsonã¨ã—ã¦ä¿å­˜
        cp github-pages-status.json data.json
        
        echo "ğŸ“Š ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº†"
        
        # çµ±è¨ˆã‚’è¡¨ç¤º
        echo "=== æ›´æ–°çµ±è¨ˆ ==="
        if [ -f data.json ]; then
          echo "âœ… data.jsonæ›´æ–°æˆåŠŸ"
          # JSONã‹ã‚‰çµ±è¨ˆæƒ…å ±ã‚’æŠ½å‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
          if command -v jq &> /dev/null; then
            echo "ğŸ“± ç·ã‚¢ãƒ—ãƒªæ•°: $(jq '.summary.total // "ä¸æ˜"' data.json)"
            echo "âœ… ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½: $(jq '.summary.accessible // "ä¸æ˜"' data.json)"
            echo "âŒ ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯: $(jq '.summary.inaccessible // "ä¸æ˜"' data.json)"
          fi
        else
          echo "âŒ data.jsonç”Ÿæˆå¤±æ•—"
          exit 1
        fi
    
    - name: Check for changes
      id: changes
      run: |
        # Gitã®å¤‰æ›´ã‚’ç¢ºèª
        if git diff --quiet data.json; then
          echo "å¤‰æ›´ãªã—"
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "å¤‰æ›´ã‚ã‚Š"
          echo "changed=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit and push changes
      if: steps.changes.outputs.changed == 'true'
      run: |
        # Gitè¨­å®š
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        git add data.json
        git commit -m "ğŸ¤– Auto-update app data

ğŸ“Š ã‚¢ãƒ—ãƒªãƒ‡ãƒ¼ã‚¿è‡ªå‹•æ›´æ–°:
- github-pages-status-checker.cjsã§æœ€æ–°çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
- published-appsãƒªãƒã‚¸ãƒˆãƒªã®å¤‰æ›´ã‚’åæ˜ 
- Firebase App Reviewerã§æ–°ã—ã„ã‚¢ãƒ—ãƒªãŒåˆ©ç”¨å¯èƒ½

ğŸ• æ›´æ–°æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S UTC')

ğŸ¤– Generated by GitHub Actions"
        
        # ãƒ—ãƒƒã‚·ãƒ¥
        git push
        
        echo "âœ… å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
    
    - name: No changes detected
      if: steps.changes.outputs.changed == 'false'
      run: |
        echo "ğŸ“ å¤‰æ›´ãªã—: data.jsonã¯æœ€æ–°ã®çŠ¶æ…‹ã§ã™"

    - name: Summary
      run: |
        echo "=== å®Ÿè¡Œã‚µãƒãƒªãƒ¼ ==="
        echo "ğŸ• å®Ÿè¡Œæ™‚åˆ»: $(date)"
        echo "ğŸ“‚ ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}"
        echo "ğŸ”„ ã‚¤ãƒ™ãƒ³ãƒˆ: ${{ github.event_name }}"
        
        if [ "${{ steps.changes.outputs.changed }}" == "true" ]; then
          echo "âœ… çµæœ: ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒ»ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†"
        else
          echo "ğŸ“ çµæœ: å¤‰æ›´ãªã—ï¼ˆæœ€æ–°çŠ¶æ…‹ï¼‰"
        fi