<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AI Chat RPA</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 12px;
            background: linear-gradient(135deg, #2d2d2d, #1a1a1a);
            color: #fff;
            user-select: none;
            overflow: hidden;
        }

        .container {
            padding: 10px;
            height: 100vh;
            box-sizing: border-box;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(90deg, #0078d4, #106ebe);
            padding: 6px 10px;
            margin: -10px -10px 10px -10px;
            cursor: move;
            border-radius: 0 0 5px 5px;
        }

        .header h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
        }

        #close-btn {
            background: #e74c3c;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 16px;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #close-btn:hover {
            background: #c0392b;
        }

        .section {
            margin-bottom: 15px;
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid #0078d4;
        }

        .section h4 {
            margin: 0 0 8px 0;
            font-size: 11px;
            color: #ccc;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-row {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
        }

        .btn-small, .btn-main, .btn-exec {
            border: none;
            color: white;
            padding: 8px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s;
            flex: 1;
        }

        .btn-small {
            background: linear-gradient(135deg, #0078d4, #106ebe);
        }

        .btn-main {
            background: linear-gradient(135deg, #16a085, #27ae60);
            width: 100%;
        }

        .btn-exec {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            width: 100%;
        }

        .btn-small:hover {
            background: linear-gradient(135deg, #106ebe, #0078d4);
            transform: translateY(-1px);
        }

        .btn-main:hover {
            background: linear-gradient(135deg, #27ae60, #16a085);
            transform: translateY(-1px);
        }

        .btn-exec:hover {
            background: linear-gradient(135deg, #c0392b, #e74c3c);
            transform: translateY(-1px);
        }

        #message {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            color: #fff;
            font-size: 11px;
            box-sizing: border-box;
        }

        #message:focus {
            outline: none;
            border-color: #0078d4;
            background: rgba(255,255,255,0.15);
        }

        #screenshot-preview {
            height: 50px;
            background: rgba(255,255,255,0.05);
            margin: 8px 0;
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #999;
            transition: all 0.3s;
        }

        #screenshot-preview.has-image {
            border-color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
            color: #27ae60;
        }

        #status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            font-size: 10px;
            color: #27ae60;
            background: rgba(0,0,0,0.8);
            padding: 6px 8px;
            border-radius: 4px;
            text-align: center;
            transition: opacity 0.3s;
            opacity: 0;
        }

        #status.show {
            opacity: 1;
        }

        .emoji {
            font-size: 14px;
            margin-right: 4px;
        }

        #log-container {
            background: rgba(0,0,0,0.7);
            border-radius: 4px;
            padding: 8px;
        }

        #log-output {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            height: 200px;
            overflow-y: auto;
            padding: 8px;
            border: 1px solid #333;
            border-radius: 3px;
            margin-bottom: 5px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h3>🤖 AI RPA Tool <span style="font-size: 10px; color: #ccc;">v0.4</span></h3>
            <button id="close-btn">×</button>
        </div>
        
        <!-- ステップ1: サイトを開く -->
        <div class="section">
            <h4>📱 サイトを開く</h4>
            <div class="btn-row">
                <button id="open-chatgpt" class="btn-small">
                    <span class="emoji">🧠</span>ChatGPT
                </button>
                <button id="open-gemini" class="btn-small">
                    <span class="emoji">💎</span>Gemini
                </button>
            </div>
        </div>

        <!-- ステップ2: スクリーンショット -->
        <div class="section">
            <h4>📷 画像取得</h4>
            <button id="screenshot" class="btn-main">
                <span class="emoji">📸</span>スクリーンショット撮影
            </button>
            <div id="screenshot-preview">撮影した画像がここに表示されます</div>
        </div>

        <!-- ステップ3: メッセージ送信 -->
        <div class="section">
            <h4>💬 メッセージ送信</h4>
            <input type="text" id="message" placeholder="送信するメッセージを入力..." value="こんにちは">
            <button id="send-message" class="btn-exec">
                <span class="emoji">🚀</span>メッセージ送信
            </button>
        </div>

        <div id="status"></div>
        
        <!-- ログ表示エリア -->
        <div class="section">
            <h4>📋 ログ</h4>
            <div id="log-container">
                <div id="log-output"></div>
                <button id="copy-logs" class="btn-small">📋 コピー</button>
                <button id="clear-logs" class="btn-small">🗑️ クリア</button>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');

        class GUIController {
            constructor() {
                this.currentScreenshot = null;
                this.logs = [];
                this.initEventListeners();
                this.addLog('アプリ起動完了');
            }

            initEventListeners() {
                // テンプレート保存通知を受信
                ipcRenderer.on('template-saved', (event, message) => {
                    this.addLog(message);
                    this.setStatus(message, 'success');
                });
                
                // 閉じるボタン
                document.getElementById('close-btn').onclick = () => {
                    window.close();
                };

                // サイトを開く
                document.getElementById('open-chatgpt').onclick = () => {
                    this.openSite('chatgpt');
                };
                
                document.getElementById('open-gemini').onclick = () => {
                    this.openSite('gemini');
                };

                // スクリーンショット
                document.getElementById('screenshot').onclick = () => {
                    this.takeScreenshot();
                };

                // メッセージ送信
                document.getElementById('send-message').onclick = () => {
                    this.sendMessage();
                };

                // Enterキーでメッセージ送信
                document.getElementById('message').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });

                // ログ機能
                document.getElementById('copy-logs').onclick = () => {
                    this.copyLogs();
                };
                
                document.getElementById('clear-logs').onclick = () => {
                    this.clearLogs();
                };
            }

            addLog(message) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `[${timestamp}] ${message}`;
                this.logs.push(logEntry);
                
                const logOutput = document.getElementById('log-output');
                logOutput.textContent = this.logs.join('\n');
                logOutput.scrollTop = logOutput.scrollHeight;
                
                console.log(logEntry);
            }

            copyLogs() {
                const logText = this.logs.join('\n');
                navigator.clipboard.writeText(logText).then(() => {
                    this.setStatus('ログをクリップボードにコピーしました', 'success');
                }).catch(err => {
                    this.setStatus('コピーに失敗しました', 'error');
                });
            }

            clearLogs() {
                this.logs = [];
                document.getElementById('log-output').textContent = '';
                this.addLog('ログをクリアしました');
            }

            async openSite(platform) {
                this.addLog(`${platform}を開く処理開始`);
                this.setStatus(`${platform}を開いています...`, 'info');
                try {
                    const result = await ipcRenderer.invoke(`open-${platform}`);
                    this.addLog(`${platform}を開く処理成功: ${result}`);
                    this.setStatus(result, 'success');
                } catch (error) {
                    this.addLog(`${platform}を開く処理エラー: ${error.message}`);
                    this.setStatus(`エラー: ${error.message}`, 'error');
                }
            }

            async takeScreenshot() {
                this.addLog('スクリーンショット撮影開始');
                this.setStatus('スクリーンショット撮影中...', 'info');
                try {
                    const base64Image = await ipcRenderer.invoke('take-screenshot');
                    this.addLog(`スクリーンショット撮影成功: データ長 ${base64Image ? base64Image.length : 'null'}`);
                    this.currentScreenshot = base64Image;
                    
                    // プレビューに小さな画像を表示
                    const preview = document.getElementById('screenshot-preview');
                    if (base64Image) {
                        preview.innerHTML = `<img src="data:image/png;base64,${base64Image}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
                        preview.classList.add('has-image');
                        this.addLog('プレビュー画像表示完了');
                        this.setStatus('スクリーンショット撮影完了！', 'success');
                    } else {
                        preview.innerHTML = 'データが空です';
                        this.addLog('エラー: 画像データが空');
                        this.setStatus('エラー: 画像データが空です', 'error');
                    }
                } catch (error) {
                    this.addLog(`スクリーンショット撮影エラー: ${error.message}`);
                    this.setStatus(`エラー: ${error.message}`, 'error');
                }
            }

            async sendMessage() {
                const message = document.getElementById('message').value.trim();
                if (!message) {
                    this.setStatus('メッセージを入力してください', 'error');
                    return;
                }

                this.setStatus(`メッセージ「${message}」を送信中...`, 'info');
                try {
                    const result = await ipcRenderer.invoke('send-message', message);
                    this.setStatus(result, 'success');
                } catch (error) {
                    this.setStatus(`エラー: ${error.message}`, 'error');
                }
            }

            setStatus(message, type = 'info') {
                const statusEl = document.getElementById('status');
                statusEl.textContent = message;
                statusEl.className = 'show';
                
                // タイプに応じて色を変更
                if (type === 'error') {
                    statusEl.style.color = '#e74c3c';
                } else if (type === 'success') {
                    statusEl.style.color = '#27ae60';
                } else {
                    statusEl.style.color = '#3498db';
                }
                
                // 3秒後にフェードアウト
                setTimeout(() => {
                    statusEl.classList.remove('show');
                }, 3000);
            }
        }

        // 初期化
        const gui = new GUIController();
        
        // ウィンドウのドラッグ機能
        const header = document.querySelector('.header');
        let isDragging = false;
        let lastMousePos = { x: 0, y: 0 };

        header.addEventListener('mousedown', (e) => {
            if (e.target.id === 'close-btn') return; // 閉じるボタンでドラッグ無効
            
            isDragging = true;
            lastMousePos.x = e.screenX;
            lastMousePos.y = e.screenY;
            
            ipcRenderer.invoke('start-drag');
            header.style.cursor = 'grabbing';
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const deltaX = e.screenX - lastMousePos.x;
                const deltaY = e.screenY - lastMousePos.y;
                
                if (Math.abs(deltaX) > 0 || Math.abs(deltaY) > 0) {
                    ipcRenderer.invoke('move-window', deltaX, deltaY);
                    lastMousePos.x = e.screenX;
                    lastMousePos.y = e.screenY;
                }
            }
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                header.style.cursor = 'move';
            }
        });
    </script>
</body>
</html>